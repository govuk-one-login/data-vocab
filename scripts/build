#!/usr/bin/env bash
ROOT_DIR="$( git rev-parse --show-toplevel )"
set -e


#
# Generate JSON Schemas
#
EXAMPLES=(
  "PostalAddressClass"
  "PassportDetailsClass"
  "DrivingPermitDetailsClass"
  "ResidencePermitDetailsClass"
  "SocialSecurityRecordDetailsClass"
  "IdCardDetailsClass"
  "NameClass"
)

#bash "${ROOT_DIR}/scripts/generate_json_schemas.sh"

#
# Generate Markdown
#

# Audit Events
rm -rf "${ROOT_DIR}/docs/audit-events"

AUDIT_EVENTS_DIR="${ROOT_DIR}/audit-events/linkml-schemas"
DEST_DIR="${ROOT_DIR}/docs/audit-events/"
#for file in ${AUDIT_EVENTS_DIR}/*AuditEvent.yaml; do 
#  echo $file
#  echo "----"
#  poetry run gen-markdown "$file" -d "${DEST_DIR}/" --index-file index.md
#done
poetry run gen-markdown "${ROOT_DIR}/audit-events/linkml-schemas/base_schema.yaml" -d "${ROOT_DIR}/docs/audit-events/" --index-file index.md --mergeimports

# Physical Data Model
rm -rf "${ROOT_DIR}/docs/v1"
poetry run gen-markdown "${ROOT_DIR}/v1/linkml-schemas/credentials.yaml" -d "${ROOT_DIR}/docs/v1/" --index-file index.md
ln -s "${ROOT_DIR}/v1/linkml-schemas" "${ROOT_DIR}/docs/v1/linkml-schemas"
ln -s "${ROOT_DIR}/v1/json-schemas" "${ROOT_DIR}/docs/v1/json-schemas"

#
# Build Examples
#
echo "Building examples"
mkdir "${ROOT_DIR}/docs/v1/examples"
for EXAMPLE in "${EXAMPLES[@]}"; do
  cp -R "${ROOT_DIR}/v1/examples/${EXAMPLE}" "${ROOT_DIR}/docs/v1/examples/${EXAMPLE}"
done


echo "Building Nav Bar"
poetry run python "${ROOT_DIR}/scripts/build_nav.py"

poetry run mkdocs build -c
